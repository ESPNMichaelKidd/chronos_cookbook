#!/bin/bash
set -o errexit -o nounset -o pipefail

app_jar=<%= "#{node['chronos']['home_dir']}/chronos.jar" %>
main=com.airbnb.scheduler.Main

heap=2048m
environment_directory=<%= "#{node['chronos']['home_dir']}/environment" %>

<% if node.attribute?('ec2') %>
public_hostname=$(curl http://169.254.169.254/latest/meta-data/public-hostname)
<% else %>
public_hostname='localhost'
<% end %>

ip=$(ifconfig | grep inet | grep -v inet6 | grep -v '127.0.0.1' | awk -F: '{ print $2 }' | awk '{ print $1 }')

# Setup the libprocess ip
echo "$ip" > "$environment_directory"/LIBPROCESS_IP


jvm_options=( -cp "$app_jar" -server -Xmx"$heap" -Xms"$heap"
              -XX:+PrintClassHistogram
              -Dfile.encoding=UTF-8
              -Djava.io.tmpdir=/tmp
              -Ddw.hostname=$public_hostname)

app_options=( server <%= "#{node['chronos']['config_dir']}/chronos.yml" %>)


function start {
  echo "$(date): $(env)"
  echo "$(date) [ulimit] $(ulimit -n)"
  exec chpst -u www-data -e $environment_directory  java "${jvm_options[@]}" "$main" "${app_options[@]}" 2>&1
}

start
